<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sua Ficha - RPG de Horror Psicológico</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css">
    <!-- Shared JS -->
    <script src="shared.js"></script>
</head>
<body>
    <div id="navbar-placeholder"></div> <!-- Placeholder for Navbar -->

    <div class="container mt-5">
        <h1 class="mb-4">Sua Ficha de Personagem</h1>
        <p class="text-center">Sessão Atual: <strong id="current-session-id"></strong></p>
        <p class="text-center">Seu ID de Usuário: <strong id="current-user-id"></strong></p>
        <!-- O botão Sair agora está na navbar -->

        <hr>

        <!-- Seção de Informações do Personagem Ativo -->
        <div id="personagem-info" class="mb-4">
            <h2 class="mb-3">Informações do Personagem</h2>
            <div class="profile-image-container">
                <img id="personagem-imagem" src="https://placehold.co/150x150/c7b299/3a2b1f?text=IMG" alt="Imagem do Personagem">
                <input type="file" id="image-upload-input" accept="image/*" class="form-control">
                <small class="form-text text-muted">Faça upload de uma imagem para seu personagem (max 5MB).</small>
            </div>
            <p><strong>Nome:</strong> <span id="personagem-nome"></span></p>
            <p><strong>Personalidade:</strong> <span id="personagem-personalidade"></span></p>
            <p><strong>Vida:</strong> <span id="personagem-vida"></span>/<span id="personagem-vida-max"></span></p>
            <p><strong>Sanidade:</strong> <span id="personagem-sanidade"></span>/<span id="personagem-sanidade-max"></span></p>
            <p><strong>Fragmentos de Esperança:</strong> <span id="personagem-fragmentos"></span></p>
            <p><strong>Fome:</strong> <span id="personagem-fome"></span></p>
            <p><strong>Corrupção:</strong> <span id="personagem-corrupcao"></span></p>

            <h3 class="mt-4">Atributos</h3>
            <ul id="lista-atributos" class="list-group list-group-flush"></ul>
            <p class="mt-3">Efeitos da Fome nos Atributos: <strong id="efeito-fome">Nenhum</strong></p>
            <p>Efeito da Corrupção nos Testes: <strong id="efeito-corrupcao">Nenhum</strong></p>
            <p>Sorte Diária (D100) Bônus/Penalidade: <strong id="sorte-diaria-bonus">0</strong></p>
        </div>

        <hr>

        <!-- Seção de Mecânicas de Jogo (Jogador) -->
        <div id="mecanicas-jogo-player" class="mb-4">
            <h2 class="mb-3">Testar Mecânicas de Jogo</h2>

            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <h3>Rolagem de D20</h3>
                    <div class="form-group mb-2">
                        <label for="select-atributo-d20" class="form-label">Atributo para teste:</label>
                        <select id="select-atributo-d20" class="form-select">
                            <!-- Opções preenchidas por JS -->
                        </select>
                    </div>
                    <div class="input-group mb-2">
                        <label for="input-alvo-d20" class="input-group-text">Alvo:</label>
                        <input type="number" id="input-alvo-d20" class="form-control" value="13" min="10" max="18">
                    </div>
                    <button class="btn btn-primary w-100" onclick="rolarD20()">Rolar D20</button>
                    <p class="mt-2">Resultado D20: <strong id="resultado-d20"></strong></p>
                </div>
                <div class="col-md-6">
                    <h3>Rolagem de D6 (Combate)</h3>
                    <div class="input-group mb-2">
                        <label for="input-alvo-d6" class="input-group-text">Alvo para Acerto:</label>
                        <input type="number" id="input-alvo-d6" class="form-control" value="4" min="4" max="6">
                    </div>
                    <button class="btn btn-primary w-100" onclick="rolarD6Combate()">Rolar D6 para Acerto</button>
                    <p class="mt-2">Resultado D6 (Acerto): <strong id="resultado-d6-acerto"></strong></p>
                    <p>Dano D4: <strong id="resultado-d4-dano"></strong></p>
                </div>
            </div>

            <div class="row g-3">
                <div class="col-md-6">
                    <h3>Rolagem de D100 (Sorte Diária)</h3>
                    <button class="btn btn-info w-100" onclick="rolarD100()">Rolar D100</button>
                    <p class="mt-2">Resultado D100: <strong id="resultado-d100"></strong></p>
                </div>
                <div class="col-md-6">
                    <h3>Simular Fome e Corrupção</h3>
                    <div class="d-grid gap-2">
                        <button class="btn btn-warning" onclick="adicionarPontoFome()">Adicionar 1 Ponto de Fome</button>
                        <button class="btn btn-danger" onclick="adicionarPontoCorrupcao()">Adicionar 1 Ponto de Corrupção</button>
                        <button class="btn btn-success" onclick="removerCorrupcao()">Remover Corrupção (Simulado)</button>
                    </div>
                    <p class="mt-2">Vida Recuperada (D4): <strong id="vida-recuperada"></strong></p>
                    <p>Sanidade Recuperada (D4): <strong id="sanidade-recuperada"></strong></p>
                </div>
            </div>
        </div>

        <hr>

        <!-- Seção de Catálogo de Compras -->
        <div id="catalogo-compras" class="mb-4">
            <h2 class="mb-3">Catálogo de Compras</h2>
            <div id="tabela-catalogo" class="table-responsive">
                <!-- Tabela preenchida por JS -->
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        // Carrega o estado da sessão
        loadRPGSessionState();

        const userRole = localStorage.getItem('userRole');
        const userId = localStorage.getItem('userId');
        const activeSessionId = localStorage.getItem('activeSessionId');
        let associatedCharacterId = localStorage.getItem('associatedCharacterId');

        // Autenticação e Autorização
        if (userRole !== 'Player' || !activeSessionId) {
            showModal('Acesso Negado', 'Você não é um Jogador ou não está em uma sessão ativa.', 'danger', () => {
                window.location.href = 'index.html';
            });
        }

        let activePlayerCharacter = null;
        if (currentSession) {
            activePlayerCharacter = currentSession.Personagens.find(p => p.OwnerUserID === userId && p.ID === associatedCharacterId);
        }

        // Redireciona para criação de personagem se não tiver um
        if (!activePlayerCharacter && associatedCharacterId === 'null') {
            showModal('Personagem Não Encontrado', 'Você ainda não tem um personagem para esta sessão. Redirecionando para a criação de personagem.', 'info', () => {
                window.location.href = 'character_creation.html';
            });
        } else if (!activePlayerCharacter) {
            showModal('Personagem Não Encontrado', 'Seu personagem não foi encontrado na sessão. Pode ser um erro ou o Mestre ainda não o adicionou. Verifique o ID da sessão.', 'danger', () => {
                // Opção para tentar entrar em outra sessão ou logout
                logout();
            });
            document.getElementById('personagem-info').innerHTML = "<p class='text-center'>Personagem não encontrado. Verifique com o Mestre ou tente entrar em outra sessão.</p>";
            document.getElementById('mecanicas-jogo-player').style.display = 'none';
            document.getElementById('catalogo-compras').style.display = 'none';
        }

        document.getElementById('current-session-id').textContent = activeSessionId;
        document.getElementById('current-user-id').textContent = userId;

        // --- Funções de Upload de Imagem ---
        document.getElementById('image-upload-input').addEventListener('change', handleImageUpload);

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const MAX_SIZE_MB = 5;
            const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/gif'];

            if (file.size > MAX_SIZE_MB * 1024 * 1024) {
                showToast(`Erro: Imagem muito grande. Max ${MAX_SIZE_MB}MB.`, 'danger');
                event.target.value = ''; // Limpa o input
                return;
            }

            if (!ALLOWED_TYPES.includes(file.type)) {
                showToast('Erro: Tipo de arquivo não permitido. Use JPG, PNG ou GIF.', 'danger');
                event.target.value = ''; // Limpa o input
                return;
            }

            // Simulação de upload: ler como URL de dados
            const reader = new FileReader();
            reader.onload = (e) => {
                const imageUrl = e.target.result;
                activePlayerCharacter.ImagemURL = imageUrl; // Atualiza a URL no personagem
                showToast('Imagem carregada com sucesso!', 'success');
                atualizarUI(); // Atualiza a UI para mostrar a nova imagem
            };
            reader.readAsDataURL(file);
        }


        // --- Funções de Atualização da UI ---
        function atualizarUI() {
            if (!activePlayerCharacter) return;

            document.getElementById('personagem-nome').textContent = activePlayerCharacter.Nome;
            document.getElementById('personagem-personalidade').textContent = activePlayerCharacter.Personalidade;
            document.getElementById('personagem-vida').textContent = activePlayerCharacter.Recursos.Vida.ValorAtual;
            document.getElementById('personagem-vida-max').textContent = activePlayerCharacter.Recursos.Vida.ValorMaximo;
            document.getElementById('personagem-sanidade').textContent = activePlayerCharacter.Recursos.Sanidade.ValorAtual;
            document.getElementById('personagem-sanidade-max').textContent = activePlayerCharacter.Recursos.Sanidade.ValorMaximo;
            document.getElementById('personagem-fragmentos').textContent = activePlayerCharacter.Recursos.FragmentosEsperanca.ValorAtual;
            document.getElementById('personagem-fome').textContent = activePlayerCharacter.Recursos.Fome.Pontos;
            document.getElementById('personagem-corrupcao').textContent = activePlayerCharacter.Recursos.Corrupcao.Pontos;

            const personagemImagem = document.getElementById('personagem-imagem');
            personagemImagem.src = activePlayerCharacter.ImagemURL || 'https://placehold.co/150x150/c7b299/3a2b1f?text=IMG';


            const listaAtributos = document.getElementById('lista-atributos');
            listaAtributos.innerHTML = '';
            const atributosParaExibir = Object.keys(activePlayerCharacter.Atributos).filter(key => key !== 'ValoresDisponiveisParaDistribuicao' && key !== 'LogicaDeDistribuicao');
            atributosParaExibir.forEach(attrName => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.textContent = `${attrName}: ${activePlayerCharacter.Atributos[attrName].Valor}`;
                listaAtributos.appendChild(li);
            });

            let efeitoFomeTexto = 'Nenhum';
            const fomePontos = activePlayerCharacter.Recursos.Fome.Pontos;
            if (fomePontos > 0) {
                efeitoFomeTexto = JSON.stringify(activePlayerCharacter.Recursos.Fome.Efeitos[`${fomePontos}Ponto`]) || 'Efeitos variados';
            }
            document.getElementById('efeito-fome').textContent = efeitoFomeTexto;

            let efeitoCorrupcaoTexto = 'Nenhum';
            const corrupcaoPontos = activePlayerCharacter.Recursos.Corrupcao.Pontos;
            if (corrupcaoPontos > 0) {
                efeitoCorrupcaoTexto = JSON.stringify(activePlayerCharacter.Recursos.Corrupcao.Efeitos[`${corrupcaoPontos}Ponto`]) || 'Efeitos variados';
            }
            document.getElementById('efeito-corrupcao').textContent = efeitoCorrupcaoTexto;

            document.getElementById('sorte-diaria-bonus').textContent = currentSession.currentGameState.SorteDiariaBonusD20;

            const selectAtributoD20 = document.getElementById('select-atributo-d20');
            selectAtributoD20.innerHTML = '';
            atributosParaExibir.forEach(attrName => {
                const option = document.createElement('option');
                option.value = attrName;
                option.textContent = attrName;
                selectAtributoD20.appendChild(option);
            });

            const tabelaCatalogoDiv = document.getElementById('tabela-catalogo');
            let tabelaHTML = '<table class="table table-bordered table-striped"><thead><tr><th>Categoria</th><th>Item/Serviço</th><th>Preço Base</th><th>Preço Atual</th><th>Ação</th></tr></thead><tbody>';
            Catalogo.ItensServicos.forEach(item => {
                const precoAtual = getPrecoAtual(item);
                tabelaHTML += `
                    <tr>
                        <td>${item.Categoria}</td>
                        <td>${item.ItemServico}</td>
                        <td>${item.PrecoBase}</td>
                        <td>${precoAtual}</td>
                        <td><button class="btn btn-sm btn-success" onclick="comprarItem('${item.ItemServico}')">Comprar</button></td>
                    </tr>
                `;
            });
            tabelaHTML += '</tbody></table>';
            tabelaCatalogoDiv.innerHTML = tabelaHTML;

            saveRPGSessionState(); // Salva o estado da sessão
        }

        // --- Funções de Mecânicas de Jogo (Jogador) ---
        function rolarD20() {
            if (!activePlayerCharacter) return;

            const atributoSelecionado = document.getElementById('select-atributo-d20').value;
            let alvo = parseInt(document.getElementById('input-alvo-d20').value);
            const valorAtributo = activePlayerCharacter.Atributos[atributoSelecionado].Valor;
            const rolagem = rolarDado(20);
            
            let bonusCorrupcao = 0;
            const corrupcaoEfeitos = activePlayerCharacter.Recursos.Corrupcao.Efeitos;
            if (activePlayerCharacter.Recursos.Corrupcao.Pontos >= 1) {
                if (activePlayerCharacter.Recursos.Corrupcao.Pontos === 1 && (atributoSelecionado === 'Sanidade' || atributoSelecionado === 'Desvio')) {
                    bonusCorrupcao += 1; 
                } else if (activePlayerCharacter.Recursos.Corrupcao.Pontos === 2 && atributoSelecionado === 'Poder') {
                     bonusCorrupcao += 1;
                } else if (activePlayerCharacter.Recursos.Corrupcao.Pontos === 3 && (atributoSelecionado === 'Sanidade' || atributoSelecionado === 'Poder' || atributoSelecionado === 'Desvio')) {
                    bonusCorrupcao += 2;
                } else if (activePlayerCharacter.Recursos.Corrupcao.Pontos === 4) {
                    bonusCorrupcao += 1; // Todos atributos alvo +1
                }
            }
            
            const rolagemComBonusSorte = rolagem + currentSession.currentGameState.SorteDiariaBonusD20;
            const rolagemTotal = rolagemComBonusSorte;

            const alvoFinal = alvo + bonusCorrupcao;

            let resultadoTexto = `Rolagem: ${rolagem} (D20). ` +
                                 `Atributo (${atributoSelecionado}): ${valorAtributo}. ` +
                                 `Bônus/Penalidade Sorte: ${currentSession.currentGameState.SorteDiariaBonusD20}. ` +
                                 `Bônus Corrupção (no alvo): +${bonusCorrupcao}. ` +
                                 `Total rolado: ${rolagemTotal}. `;

            if (rolagemTotal >= alvoFinal) {
                resultadoTexto += `SUCESSO! (Alvo ${alvoFinal})`;
                showToast("Teste de D20: SUCESSO!", 'success');
            } else {
                resultadoTexto += `FALHA! (Alvo ${alvoFinal})`;
                showToast("Teste de D20: FALHA!", 'danger');
                if (atributoSelecionado === 'Poder' || atributoSelecionado === 'Inteligencia') {
                     const danoSanidade = rolarDado(4);
                     MecanicasJogo.AplicarPerdaSanidade(activePlayerCharacter, danoSanidade);
                     resultadoTexto += ` Perdeu ${danoSanidade} de Sanidade.`;
                     showToast(`Perdeu ${danoSanidade} de Sanidade!`, 'warning');
                }
                if (activePlayerCharacter.Estado.EfeitosTemporarios.some(e => e.Nome === 'Patuá Amaldiçoado')) {
                    activePlayerCharacter.Recursos.Corrupcao.Pontos = Math.min(MecanicasJogo.TratamentoLimitesRecursos.CorrupcaoMaxima, activePlayerCharacter.Recursos.Corrupcao.Pontos + 1);
                    resultadoTexto += ` Ganhou 1 ponto de Corrupção devido ao Patuá Amaldiçoado.`;
                    showToast(`Ganhou 1 ponto de Corrupção devido ao Patuá Amaldiçoado!`, 'danger');
                }
            }
            document.getElementById('resultado-d20').textContent = resultadoTexto;
            atualizarUI();
        }

        function rolarD6Combate() {
            if (!activePlayerCharacter) return;

            const alvoD6 = parseInt(document.getElementById('input-alvo-d6').value);
            const rolagemD6 = rolarDado(6);
            let resultadoAcerto = `Rolagem D6: ${rolagemD6}. `;
            let danoD4Texto = '';

            if (rolagemD6 >= alvoD6) {
                resultadoAcerto += `ACERTOU!`;
                showToast("Acerto em Combate!", 'success');
                const rolagemDano = rolarDado(4);
                danoD4Texto = `Causou ${rolagemDano} de dano (D4).`;
                activePlayerCharacter.Recursos.Vida.ValorAtual = Math.max(MecanicasJogo.TratamentoLimitesRecursos.VidaMinima, activePlayerCharacter.Recursos.Vida.ValorAtual - rolagemDano);
                showToast(`Inimigo sofreu ${rolagemDano} de dano!`, 'info');
            } else {
                resultadoAcerto += `ERROU!`;
                showToast("Errou o ataque!", 'warning');
            }
            document.getElementById('resultado-d6-acerto').textContent = resultadoAcerto;
            document.getElementById('resultado-d4-dano').textContent = danoD4Texto;
            atualizarUI();
        }

        function rolarD100() {
            const dezena = rolarDado(10) * 10;
            const unidade = rolarDado(10);
            let rolagem = dezena + unidade;
            if (rolagem === 0) rolagem = 100; // D100 pode ser 00-99 ou 1-100. Vamos usar 1-100 para simplificar.

            currentSession.currentGameState.SorteDiariaBonusD20 = 0;

            let bonusTexto = '';
            if (rolagem >= 1 && rolagem <= 20) {
                currentSession.currentGameState.SorteDiariaBonusD20 = -2;
                bonusTexto = `-2 em um teste D20.`;
            } else if (rolagem >= 21 && rolagem <= 49) {
                currentSession.currentGameState.SorteDiariaBonusD20 = 0;
                bonusTexto = `Normal, sem efeito.`;
            } else if (rolagem >= 50 && rolagem <= 79) {
                currentSession.currentGameState.SorteDiariaBonusD20 = +2;
                bonusTexto = `+2 em um teste D20.`;
            } else if (rolagem >= 80 && rolagem <= 100) {
                currentSession.currentGameState.SorteDiariaBonusD20 = +5;
                bonusTexto = `+5 em um teste D20.`;
            }

            document.getElementById('resultado-d100').textContent = `Rolagem D100: ${rolagem}. Efeito: ${bonusTexto}`;
            showToast(`Sorte do Dia: ${bonusTexto}`, 'info');
            atualizarUI();
        }

        function adicionarPontoFome() {
            if (!activePlayerCharacter) return;
            if (activePlayerCharacter.Recursos.Fome.Pontos < MecanicasJogo.TratamentoLimitesRecursos.FomeMaxima) {
                activePlayerCharacter.Recursos.Fome.Pontos++;
                showToast(`Adicionado 1 ponto de Fome. Total: ${activePlayerCharacter.Recursos.Fome.Pontos}.`, 'warning');
            } else {
                showToast('Fome no máximo (5 pontos). Consequências graves!', 'danger');
            }
            atualizarUI();
        }

        function adicionarPontoCorrupcao() {
            if (!activePlayerCharacter) return;
            if (activePlayerCharacter.Recursos.Corrupcao.Pontos < MecanicasJogo.TratamentoLimitesRecursos.CorrupcaoMaxima) {
                activePlayerCharacter.Recursos.Corrupcao.Pontos++;
                showToast(`Adicionado 1 ponto de Corrupção. Total: ${activePlayerCharacter.Recursos.Corrupcao.Pontos}.`, 'danger');
            } else {
                showToast('Corrupção no máximo (5 pontos). Consequências graves!', 'danger');
            }
            atualizarUI();
        }

        function removerCorrupcao() {
            if (!activePlayerCharacter) return;
            if (activePlayerCharacter.Recursos.Corrupcao.Pontos > 0) {
                showModal('Confirmar Remoção de Corrupção', 'Tem certeza que deseja remover todos os pontos de Corrupção? (Simulado)', 'warning',
                    () => {
                        activePlayerCharacter.Recursos.Corrupcao.Pontos = 0;
                        showToast('Corrupção removida (simulado).', 'success');
                        atualizarUI();
                    }
                );
            } else {
                showToast('Nenhum ponto de Corrupção para remover.', 'info');
            }
        }

        // --- Funções de Compra e Efeitos de Itens ---
        function comprarItem(nomeItem) {
            if (!activePlayerCharacter) return;

            const item = Catalogo.ItensServicos.find(i => i.ItemServico === nomeItem);
            if (!item) {
                showToast('Item não encontrado.', 'danger');
                return;
            }

            const preco = getPrecoAtual(item);

            if (activePlayerCharacter.Recursos.FragmentosEsperanca.ValorAtual >= preco) {
                showModal('Confirmar Compra', `Deseja comprar ${nomeItem} por ${preco} Fragmentos de Esperança?`, 'info',
                    () => {
                        activePlayerCharacter.Recursos.FragmentosEsperanca.ValorAtual -= preco;
                        showToast(`Você comprou ${nomeItem} por ${preco} Fragmentos de Esperança.`, 'success');

                        let efeitoMensagem = item.Efeito;
                        if (item.Efeito.includes("Remove 1 fase Fome") && item.Efeito.includes("Recupera D4 Vida")) {
                            activePlayerCharacter.Recursos.Fome.Pontos = Math.max(0, activePlayerCharacter.Recursos.Fome.Pontos - 1);
                            const vidaRec = rolarDado(4);
                            activePlayerCharacter.Recursos.Vida.ValorAtual = Math.min(activePlayerCharacter.Recursos.Vida.ValorMaximo, activePlayerCharacter.Recursos.Vida.ValorAtual + vidaRec);
                            document.getElementById('vida-recuperada').textContent = `Recuperou ${vidaRec} de Vida.`;
                            document.getElementById('sanidade-recuperada').textContent = '';
                            efeitoMensagem = `Removeu 1 fase de Fome e recuperou ${vidaRec} de Vida.`;
                        } else if (item.Efeito.includes("Remove todas fases Fome") && item.Efeito.includes("Recupera D4 Sanidade")) {
                            const sanidadeRec = rolarDado(4);
                            activePlayerCharacter.Recursos.Sanidade.ValorAtual = Math.min(activePlayerCharacter.Recursos.Sanidade.ValorMaximo, activePlayerCharacter.Recursos.Sanidade.ValorAtual + sanidadeRec);
                            activePlayerCharacter.Recursos.Fome.Pontos = 0;
                            document.getElementById('sanidade-recuperada').textContent = `Recuperou ${sanidadeRec} de Sanidade.`;
                            document.getElementById('vida-recuperada').textContent = '';
                            efeitoMensagem = `Removeu toda Fome e recuperou ${sanidadeRec} de Sanidade.`;
                        } else if (item.Efeito.includes("Recupera D4 Vida OU Sanidade")) {
                            showModal('Escolha de Recuperação', 'Deseja recuperar Vida (Confirmar) ou Sanidade (Cancelar)?', 'info',
                                () => { // Confirmar: Vida
                                    const recuperacao = rolarDado(4);
                                    activePlayerCharacter.Recursos.Vida.ValorAtual = Math.min(activePlayerCharacter.Recursos.Vida.ValorMaximo, activePlayerCharacter.Recursos.Vida.ValorAtual + recuperacao);
                                    showToast(`Recuperou ${recuperacao} de Vida.`, 'success');
                                    atualizarUI();
                                },
                                () => { // Cancelar: Sanidade
                                    const recuperacao = rolarDado(4);
                                    activePlayerCharacter.Recursos.Sanidade.ValorAtual = Math.min(activePlayerCharacter.Recursos.Sanidade.ValorMaximo, activePlayerCharacter.Recursos.Sanidade.ValorAtual + recuperacao);
                                    showToast(`Recuperou ${recuperacao} de Sanidade.`, 'success');
                                    atualizarUI();
                                }
                            );
                            return; // Sai da função principal para esperar a escolha do modal
                        } else if (item.Efeito.includes("Recupera D6 Vida OU Sanidade")) {
                            showModal('Escolha de Recuperação Avançada', 'Deseja recuperar Vida (Confirmar) ou Sanidade (Cancelar)?', 'info',
                                () => { // Confirmar: Vida
                                    const recuperacao = rolarDado(6);
                                    activePlayerCharacter.Recursos.Vida.ValorAtual = Math.min(activePlayerCharacter.Recursos.Vida.ValorMaximo, activePlayerCharacter.Recursos.Vida.ValorAtual + recuperacao);
                                    let msg = `Recuperou ${recuperacao} de Vida.`;
                                    if (activePlayerCharacter.Estado.Condicao.includes('Aflito')) {
                                        activePlayerCharacter.Estado.Condicao = activePlayerCharacter.Estado.Condicao.filter(c => c !== 'Aflito');
                                        msg += " e removeu a condição 'Aflito'.";
                                    }
                                    showToast(msg, 'success');
                                    atualizarUI();
                                },
                                () => { // Cancelar: Sanidade
                                    const recuperacao = rolarDado(6);
                                    activePlayerCharacter.Recursos.Sanidade.ValorAtual = Math.min(activePlayerCharacter.Recursos.Sanidade.ValorMaximo, activePlayerCharacter.Recursos.Sanidade.ValorAtual + recuperacao);
                                    let msg = `Recuperou ${recuperacao} de Sanidade.`;
                                    if (activePlayerCharacter.Estado.Condicao.includes('Aflito')) {
                                        activePlayerCharacter.Estado.Condicao = activePlayerCharacter.Estado.Condicao.filter(c => c !== 'Aflito');
                                        msg += " e removeu a condição 'Aflito'.";
                                    }
                                    showToast(msg, 'success');
                                    atualizarUI();
                                }
                            );
                            return;
                        } else if (item.Efeito.includes("+2 em um teste D20 de Inteligência ou Poder")) {
                            activePlayerCharacter.Estado.EfeitosTemporarios.push({ Nome: 'Chá de Ervas', Efeito: item.Efeito, Duracao: '1 Teste' });
                            showToast("Chá de Ervas aplicado! Efeito temporário.", 'info');
                        } else if (item.Efeito.includes("+3 em D20 Poder. Falha no teste de Poder (com ou sem bônus) resulta em 1 Corrupção.")) {
                            activePlayerCharacter.Estado.EfeitosTemporarios.push({ Nome: 'Patuá Amaldiçoado', Efeito: item.Efeito, Duracao: 'Permanente' });
                            showToast("Patuá Amaldiçoado adquirido! Cuidado com as falhas em Poder.", 'warning');
                        } else if (item.Efeito.includes("Fornece uma pista (teste D20 Inteligência, alvo 15). Falha resulta em perda de D4 Sanidade.")) {
                            showToast(`Você adquiriu o ${nomeItem}. O Mestre pode pedir um teste de Inteligência (alvo 15).`, 'info');
                        }
                        atualizarUI();
                    }
                );
            } else {
                showToast(`Fragmentos de Esperança insuficientes para comprar ${nomeItem}. Você tem ${activePlayerCharacter.Recursos.FragmentosEsperanca.ValorAtual}, precisa de ${preco}.`, 'danger');
            }
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            renderNavbar('player'); // Passa o identificador da página atual
            if (activePlayerCharacter) {
                atualizarUI();
            }
        });
    </script>
</body>
</html>
