<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrar na Sessão - RPG de Horror Psicológico</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css">
    <!-- Shared JS -->
    <script src="shared.js"></script>
</head>
<body>
    <div id="navbar-placeholder"></div> <!-- Placeholder for Navbar -->

    <div class="container mt-5">
        <h1 class="mb-4">Entrar na Sessão</h1>
        <p class="text-center">Seu ID de Usuário: <strong id="current-user-id"></strong></p>

        <div class="form-group mb-4">
            <label for="session-id-input" class="form-label">Insira o ID da Sessão fornecido pelo Mestre:</label>
            <input type="text" id="session-id-input" class="form-control" placeholder="Ex: xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx">
            <small class="form-text text-muted">Certifique-se de que o ID está correto para entrar na sessão certa.</small>
        </div>
        <div class="d-grid gap-2">
            <button class="btn btn-primary" onclick="joinSession()">Entrar na Sessão</button>
            <!-- O botão Sair agora está na navbar -->
        </div>
        <p id="join-status" class="alert alert-danger mt-3" style="display: none;"></p>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        // Carrega o estado compartilhado (apenas para ter acesso às funções auxiliares)
        // O estado da sessão será carregado APÓS o join.
        // loadStateFromLocalStorage(); // Não carregar aqui, pois o ID da sessão ainda não está definido

        const userRole = localStorage.getItem('userRole');
        const userId = localStorage.getItem('userId');

        // Redireciona se não for jogador ou se já tiver uma sessão ativa
        if (userRole !== 'Player') {
            showModal('Acesso Negado', 'Você não é um Jogador.', 'danger', () => {
                window.location.href = 'index.html';
            });
        }
        if (localStorage.getItem('activeSessionId')) {
            window.location.href = 'player.html'; // Já está em uma sessão, vai para a ficha
        }

        document.getElementById('current-user-id').textContent = userId;

        function joinSession() {
            const sessionId = document.getElementById('session-id-input').value.trim();
            const joinStatus = document.getElementById('join-status');
            joinStatus.style.display = 'none'; // Esconder mensagem anterior

            if (!sessionId) {
                joinStatus.textContent = "Por favor, insira um ID de sessão válido.";
                joinStatus.style.display = 'block';
                return;
            }

            localStorage.setItem('activeSessionId', sessionId);
            // Agora que o activeSessionId está definido, podemos carregar o estado da sessão.
            loadRPGSessionState(); 

            // Simula adicionar o jogador à lista de usuários da sessão (para o Mestre ver)
            // Em um sistema real, isso seria uma atualização no Firestore na coleção 'users' ou 'sessions'
            let sessionUsers = JSON.parse(localStorage.getItem('sessionUsers') || '[]');
            if (!sessionUsers.some(u => u.userId === userId)) {
                sessionUsers.push({ userId: userId, associatedCharacterId: localStorage.getItem('associatedCharacterId') });
                localStorage.setItem('sessionUsers', JSON.stringify(sessionUsers));
            }

            showToast(`Você entrou na sessão: ${sessionId}`, 'success');
            window.location.href = 'player.html';
        }

        // Inicialização da Navbar
        document.addEventListener('DOMContentLoaded', () => {
            renderNavbar('session_join'); // Passa o identificador da página atual
        });
    </script>
</body>
</html>
